<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon2.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>ゲームづくり編3　マップを表示してキャラクターを動かそう</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#ゲームのマップ" id="toc-ゲームのマップ"><span
class="toc-section-number">1</span> ゲームのマップ</a></li>
<li><a href="#もくじ" id="toc-もくじ"><span
class="toc-section-number">2</span> もくじ</a></li>
<li><a href="#マップチップとは" id="toc-マップチップとは"><span
class="toc-section-number">3</span> マップチップとは</a></li>
<li><a href="#tkinterでウィンドウを表示する"
id="toc-tkinterでウィンドウを表示する"><span
class="toc-section-number">4</span>
Tkinterでウィンドウを表示する</a></li>
<li><a href="#マップチップを表示する"
id="toc-マップチップを表示する"><span
class="toc-section-number">5</span> マップチップを表示する</a></li>
<li><a href="#枚の画像からマップチップを取得する"
id="toc-枚の画像からマップチップを取得する"><span
class="toc-section-number">6</span>
1枚の画像からマップチップを取得する</a></li>
<li><a href="#データをもとにマップチップを配置する"
id="toc-データをもとにマップチップを配置する"><span
class="toc-section-number">7</span>
データをもとにマップチップを配置する</a></li>
<li><a href="#さらに豪華なマップを作ろう"
id="toc-さらに豪華なマップを作ろう"><span
class="toc-section-number">8</span> さらに豪華なマップを作ろう</a></li>
<li><a href="#キャラチップとは" id="toc-キャラチップとは"><span
class="toc-section-number">9</span> キャラチップとは</a></li>
<li><a href="#キャラクターを表示させて移動する"
id="toc-キャラクターを表示させて移動する"><span
class="toc-section-number">10</span>
キャラクターを表示させて移動する</a></li>
<li><a href="#水の中には入れないようにする"
id="toc-水の中には入れないようにする"><span
class="toc-section-number">11</span>
水の中には入れないようにする</a></li>
<li><a href="#キャラクターをアニメーションさせる"
id="toc-キャラクターをアニメーションさせる"><span
class="toc-section-number">12</span>
キャラクターをアニメーションさせる</a></li>
<li><a href="#組み合わせる" id="toc-組み合わせる"><span
class="toc-section-number">13</span> 組み合わせる</a></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>Pythonで釣りゲームを作ろう
ゲームづくり編3　マップを表示してキャラクターを動かそう</p>
      <p>2024年12月6日（金）</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="ゲームのマップ"><span
      class="header-section-number">1</span> ゲームのマップ</h1>
      <p>マップ画面は、RPG（ロールプレイングゲーム）やシミュレーションゲームなど、多くのゲームで欠かせない要素です。今回は、<strong>マップチップ</strong>と呼ばれるものを使って、マップを描写してみましょう。後半では、作成したマップの上を、キャラクターで移動できるようにしましょう。<strong>キャラチップ</strong>と呼ばれる画像を用いてキャラクタの歩行を行います。</p>
      <p><br></p>
      <h1 data-number="2" id="もくじ"><span
      class="header-section-number">2</span> もくじ</h1>
      <ul>
      <li><a
      href="advance03.html#マップチップとは">マップチップとは</a></li>
      <li><a
      href="advance03.html#Tkinterでウィンドウを表示する">Tkinterでウィンドウを表示する</a></li>
      <li><a
      href="advance03.html#マップチップを表示する">マップチップを表示する</a></li>
      <li><a
      href="advance03.html#1枚の画像からマップチップを取得する">1枚の画像からマップチップを取得する</a></li>
      <li><a
      href="advance03.html#データをもとにマップチップを配置する">データをもとにマップチップを配置する</a></li>
      <li><a
      href="advance03.html#さらに豪華なマップを作ろう">さらに豪華なマップを作ろう</a></li>
      </ul>
      <hr />
      <ul>
      <li><a
      href="advance03.html#キャラチップとは">キャラチップとは</a></li>
      <li><a
      href="advance03.html#キャラクターを表示させて移動する">キャラクターを表示させて移動する</a></li>
      <li><a
      href="advance03.html#水の中には入れないようにする">水の中には入れないようにする</a></li>
      <li><a
      href="advance03.html#キャラクターをアニメーションさせる">キャラクターをアニメーションさせる</a></li>
      <li><a href="advance03.html#組み合わせる">組み合わせる</a></li>
      </ul>
      <p><br></p>
      <h1 data-number="3" id="マップチップとは"><span
      class="header-section-number">3</span> マップチップとは</h1>
      <p>ゲームには、プレイヤーが探索するフィールド、都市、ダンジョンなど、さまざまな場所が登場します。しかし、一枚一枚のマップを手作業で描いていくとなると、膨大な時間と労力が必要になります。そこで登場するのが<strong>マップチップ</strong>です。マップチップとは、草地や水辺、道路など、<strong>地形やオブジェクト(チェストやタンスなどの「もの」)を表す小さな画像パーツ</strong>のことです。これらを組み合わせることで、効率的にマップを構築することができます。</p>
      <p>画像の用意や処理がシンプルなため、容量制限の厳しかった昔はほとんどのゲームでマップチップが採用されていました。マップチップを用いれば、初心者でも簡単に取り組めます。</p>
      <p><br></p>
      <p>今回は、<code>grass.png</code> <code>sand.png</code>
      <code>water.png</code>の3枚の画像を用います。ダウンロードして<code>img</code>フォルダに入れておいてください。</p>
      <p><img src="./figs/103/grass.png" alt="img" /><img
      src="./figs/103/sand.png" alt="img" /><img
      src="./figs/103/water.png" alt="img" /></p>
      <p>これらの画像は、基本的に同じサイズでそろえることをおすすめします。今回は<code>64x64px</code>で統一しています。</p>
      <p><br></p>
      <h1 data-number="4" id="tkinterでウィンドウを表示する"><span
      class="header-section-number">4</span>
      Tkinterでウィンドウを表示する</h1>
      <p>新しいファイル<code>map01.py</code>を作成して、ウィンドウを表示するプログラムを制作していきましょう。</p>
      <div class="sourceCode" id="cb1" data-startFrom="1"
      data-caption="map01.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> tkinter <span class="im">as</span> tk</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt;&gt;ディレクトリ&gt;&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>cwd <span class="op">=</span> os.getcwd()</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt;&gt;マップ設定&gt;&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>CHIP_SIZE <span class="op">=</span> <span class="dv">64</span> <span class="co">#マップチップの大きさ</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>X_MAPSIZE <span class="op">=</span> <span class="dv">20</span> <span class="co">#マップのx方向タイル数</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>Y_MAPSIZE <span class="op">=</span> <span class="dv">10</span> <span class="co">#マップのy方向タイル数</span></span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt;&gt;ウィンドウ、キャンバス&gt;&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>CANVAS_WIDTH <span class="op">=</span> CHIP_SIZE <span class="op">*</span> X_MAPSIZE <span class="co">#キャンバス幅</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>CANVAS_HEIGHT <span class="op">=</span> CHIP_SIZE <span class="op">*</span> Y_MAPSIZE <span class="co">#キャンバス高さ</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>MARGINE_X <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>MARGINE_Y <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>CANVAS_SIZE <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>CANVAS_WIDTH<span class="op">+</span>MARGINE_X<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>CANVAS_HEIGHT<span class="op">+</span>MARGINE_Y<span class="sc">}</span><span class="ss">&quot;</span><span class="co">#キャンバスサイズ</span></span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">#ウィンドウ設置</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>root <span class="op">=</span> tk.Tk()</span>
<span id="cb1-21"><a href="#cb1-21"></a>root.title(<span class="st">&quot;マップ表示&quot;</span>)</span>
<span id="cb1-22"><a href="#cb1-22"></a>root.geometry(CANVAS_SIZE)</span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">#キャンバス設置</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>canvas <span class="op">=</span> tk.Canvas(root,width <span class="op">=</span> CANVAS_WIDTH,height <span class="op">=</span> CANVAS_HEIGHT,bg <span class="op">=</span> <span class="st">&quot;skyblue&quot;</span>)</span>
<span id="cb1-26"><a href="#cb1-26"></a>canvas.pack()</span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="co">#&gt;&gt;マップチップ&gt;&gt;</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>MAP_CHIP <span class="op">=</span> [</span>
<span id="cb1-31"><a href="#cb1-31"></a>    tk.PhotoImage(<span class="bu">file</span> <span class="op">=</span> cwd<span class="op">+</span><span class="st">&quot;/img/grass.png&quot;</span>),</span>
<span id="cb1-32"><a href="#cb1-32"></a>    tk.PhotoImage(<span class="bu">file</span> <span class="op">=</span> cwd<span class="op">+</span><span class="st">&quot;/img/sand.png&quot;</span>),</span>
<span id="cb1-33"><a href="#cb1-33"></a>    tk.PhotoImage(<span class="bu">file</span> <span class="op">=</span> cwd<span class="op">+</span><span class="st">&quot;/img/water.png&quot;</span>)</span>
<span id="cb1-34"><a href="#cb1-34"></a>    ]</span>
<span id="cb1-35"><a href="#cb1-35"></a></span>
<span id="cb1-36"><a href="#cb1-36"></a>root.mainloop()</span></code></pre></div>
      <p>最初の方で多くの数字を設定しています。マップチップの大きさや、マップのサイズなどです。このように、様々な値を変数で置いておくことで、あとからの修正が楽になります。</p>
      <p>そして、用意した画像は最後の方で<strong>リスト</strong>に格納されています。</p>
      <hr />
      <ul>
      <li><strong>ChallengeA3-1</strong>　草の画像を呼び出したいとき、どのように記述したら良いですか。</li>
      </ul>
      <p><strong><i class="fa-solid fa-check"></i>解答</strong></p>
      <p><span class="masked"><code>MAP_CHIP[0]</code></span></p>
      <p><br></p>
      <h1 data-number="5" id="マップチップを表示する"><span
      class="header-section-number">5</span> マップチップを表示する</h1>
      <p>以下の一文を<code>root.mainloop()</code>の前に追加してみてください。</p>
      <div class="sourceCode" id="cb2" data-startFrom="36"
      data-caption="map01.py（続き）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 35;"><span id="cb2-36"><a href="#cb2-36"></a>canvas.create_image(<span class="dv">0</span>,<span class="dv">0</span>,image <span class="op">=</span>MAP_CHIP[<span class="dv">0</span>] ,tag<span class="op">=</span><span class="st">&quot;chip1&quot;</span>,anchor<span class="op">=</span>tk.NW)</span></code></pre></div>
      <p>実行すると、マップチップが表示されます。</p>
      <figure>
      <img src="./figs/103/putGrass.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><br></p>
      <p>これを並べていけばマップが作れます。一つ右に砂地を配置してみましょう。</p>
      <div class="sourceCode" id="cb3" data-startFrom="37"
      data-caption="map01.py（続き）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 36;"><span id="cb3-37"><a href="#cb3-37"></a>canvas.create_image(CHIP_SIZE,<span class="dv">0</span>,image <span class="op">=</span>MAP_CHIP[<span class="dv">1</span>] ,tag<span class="op">=</span><span class="st">&quot;chip2&quot;</span>,anchor<span class="op">=</span>tk.NW)</span></code></pre></div>
      <p>これを繰り返し行えばよいので、繰り返し文を用いてみましょう。<strong>先ほどの画像を配置する2文を消して、以下のプログラムを追加してください。</strong></p>
      <div class="sourceCode" id="cb4" data-startFrom="36"
      data-caption="map01.py（続き）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 35;"><span id="cb4-36"><a href="#cb4-36"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(Y_MAPSIZE):</span>
<span id="cb4-37"><a href="#cb4-37"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(X_MAPSIZE):</span>
<span id="cb4-38"><a href="#cb4-38"></a>        canvas.create_image(x<span class="op">*</span>CHIP_SIZE,y<span class="op">*</span>CHIP_SIZE,image <span class="op">=</span>MAP_CHIP[<span class="dv">0</span>] ,tag<span class="op">=</span><span class="ss">f&quot;chip</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">&quot;</span>,anchor<span class="op">=</span>tk.NW)</span></code></pre></div>
      <p>ウィンドウが草地で埋め尽くされたら成功です。</p>
      <figure>
      <img src="./figs/103/allgreen.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><br></p>
      <h1 data-number="6" id="枚の画像からマップチップを取得する"><span
      class="header-section-number">6</span>
      1枚の画像からマップチップを取得する</h1>
      <p>今回はマップチップは3種類しかありませんが、これが50種類、100種類と増えてくると画像の管理が大変になります。そこで、通常は<strong>マップチップを並べた画像1枚</strong>を分割して利用します。</p>
      <p>以下の画像をダウンロードして<code>sheet1.png</code>という名前で<code>img</code>フォルダに入れておいてください。</p>
      <figure>
      <img src="./figs/103/sheet1.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>1枚の画像を分割するためには、<strong>Pillow</strong>と呼ばれるライブラリが必要になります。ターミナルで、以下を入力して実行してください。</p>
      <pre><code>pip install Pillow</code></pre>
      <figure>
      <img src="./figs/103/install.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <div class="sourceCode" id="cb6" data-startFrom="1"
      data-caption="map02.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">import</span> os</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">import</span> tkinter <span class="im">as</span> tk</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">from</span> PIL <span class="im">import</span> Image,ImageTk</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt;&gt;ディレクトリ&gt;&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>cwd <span class="op">=</span> os.getcwd()</span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt;&gt;マップ設定&gt;&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>CHIP_SIZE <span class="op">=</span> <span class="dv">64</span> <span class="co">#マップチップの大きさ</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>X_MAPSIZE <span class="op">=</span> <span class="dv">20</span> <span class="co">#マップのx方向タイル数</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>Y_MAPSIZE <span class="op">=</span> <span class="dv">10</span> <span class="co">#マップのy方向タイル数</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt;&gt;ウィンドウ、キャンバス&gt;&gt;</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>CANVAS_WIDTH <span class="op">=</span> CHIP_SIZE <span class="op">*</span> X_MAPSIZE <span class="co">#キャンバス幅</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>CANVAS_HEIGHT <span class="op">=</span> CHIP_SIZE <span class="op">*</span> Y_MAPSIZE <span class="co">#キャンバス高さ</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>MARGINE_X <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>MARGINE_Y <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>CANVAS_SIZE <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>CANVAS_WIDTH<span class="op">+</span>MARGINE_X<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>CANVAS_HEIGHT<span class="op">+</span>MARGINE_Y<span class="sc">}</span><span class="ss">&quot;</span><span class="co">#キャンバスサイズ</span></span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co">#ウィンドウ設置</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>root <span class="op">=</span> tk.Tk()</span>
<span id="cb6-22"><a href="#cb6-22"></a>root.title(<span class="st">&quot;マップ表示&quot;</span>)</span>
<span id="cb6-23"><a href="#cb6-23"></a>root.geometry(CANVAS_SIZE)</span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">#キャンバス設置</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>canvas <span class="op">=</span> tk.Canvas(root,width <span class="op">=</span> CANVAS_WIDTH,height <span class="op">=</span> CANVAS_HEIGHT,bg <span class="op">=</span> <span class="st">&quot;skyblue&quot;</span>)</span>
<span id="cb6-27"><a href="#cb6-27"></a>canvas.pack()</span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a></span>
<span id="cb6-30"><a href="#cb6-30"></a><span class="co">#&gt;&gt;マップチップ&gt;&gt;</span></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">#マップチップを1枚の画像に並べたマップシートを読み込む</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>MAP_SHEET <span class="op">=</span> Image.<span class="bu">open</span>(cwd<span class="op">+</span><span class="st">&quot;/img/sheet1.png&quot;</span>)</span>
<span id="cb6-33"><a href="#cb6-33"></a></span>
<span id="cb6-34"><a href="#cb6-34"></a><span class="co">#読み込んだ画像から縦横何枚ずつチップがあるか求める</span></span>
<span id="cb6-35"><a href="#cb6-35"></a>CHIP_X <span class="op">=</span> MAP_SHEET.width <span class="op">//</span> CHIP_SIZE</span>
<span id="cb6-36"><a href="#cb6-36"></a>CHIP_Y <span class="op">=</span> MAP_SHEET.height <span class="op">//</span> CHIP_SIZE</span>
<span id="cb6-37"><a href="#cb6-37"></a></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="co">#マップシートをマップチップに分割し配列に格納する</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>MAP_CHIP <span class="op">=</span> []</span>
<span id="cb6-40"><a href="#cb6-40"></a></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(CHIP_Y):</span>
<span id="cb6-42"><a href="#cb6-42"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(CHIP_X):</span>
<span id="cb6-43"><a href="#cb6-43"></a>        image <span class="op">=</span> ImageTk.PhotoImage(MAP_SHEET.crop((</span>
<span id="cb6-44"><a href="#cb6-44"></a>            CHIP_SIZE<span class="op">*</span>x , </span>
<span id="cb6-45"><a href="#cb6-45"></a>            CHIP_SIZE<span class="op">*</span>y , </span>
<span id="cb6-46"><a href="#cb6-46"></a>            CHIP_SIZE<span class="op">*</span>(x<span class="op">+</span><span class="dv">1</span>) , </span>
<span id="cb6-47"><a href="#cb6-47"></a>            CHIP_SIZE<span class="op">*</span>(y<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb6-48"><a href="#cb6-48"></a>            )))</span>
<span id="cb6-49"><a href="#cb6-49"></a>        MAP_CHIP.append(image)</span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(Y_MAPSIZE):</span>
<span id="cb6-52"><a href="#cb6-52"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(X_MAPSIZE):</span>
<span id="cb6-53"><a href="#cb6-53"></a>        canvas.create_image(x<span class="op">*</span>CHIP_SIZE,y<span class="op">*</span>CHIP_SIZE,image <span class="op">=</span>MAP_CHIP[<span class="dv">1</span>] ,tag<span class="op">=</span><span class="ss">f&quot;chip</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">&quot;</span>,anchor<span class="op">=</span>tk.NW)</span>
<span id="cb6-54"><a href="#cb6-54"></a></span>
<span id="cb6-55"><a href="#cb6-55"></a>root.mainloop()</span></code></pre></div>
      <p>まず、<code>35行目</code>
      <code>36行目</code>で、読み込んだ画像に縦横何枚ずつチップが並べられているか計算しています。</p>
      <p><code>MAP_SHEET.width</code>が読み込んだ画像の幅です。これをマップチップ1枚の幅<code>CHIP_SIZE</code>で割ることで、横に並んでいるマップチップの枚数<code>CHIP_X</code>を求めます。</p>
      <div class="sourceCode" id="cb7" data-startFrom="35"
      data-caption="map02.py（抜粋）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 34;"><span id="cb7-35"><a href="#cb7-35"></a>CHIP_X <span class="op">=</span> MAP_SHEET.width <span class="op">//</span> CHIP_SIZE</span></code></pre></div>
      <p><code>41行目</code>からは2重ループを用いてマップチップを1枚1枚切り取り、リストに格納しています。</p>
      <p>これで、マップを表示する仕組みは完成しました。</p>
      <p><br></p>
      <h1 data-number="7"
      id="データをもとにマップチップを配置する"><span
      class="header-section-number">7</span>
      データをもとにマップチップを配置する</h1>
      <p>マップを表示するためのデータは、二次元リストで簡単につくれます。</p>
      <div class="sourceCode" id="cb8"
      data-caption="マップのデータ"><pre
      class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>MAP_DATA <span class="op">=</span> [</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
      <p>リスト上のそれぞれの数字がマップチップの番号に対応しています。<strong>1と書いてある場所には草地が</strong>、<strong>2と書いてある場所には砂地が</strong>配置されます。</p>
      <hr />
      <ul>
      <li><strong>ChallengeA3-2</strong>　以下のプログラムの<code>69行目</code>を改造して、データをもとにマップが表示されるようにしましょう。</li>
      </ul>
      <p>ヒント：以下のプログラムでは、<code>img = MAP_CHIP[1]</code>となっているので全て草地が配置されます。この<code>1</code>をマップのデータに変えれば、配置される画像も場所によって変わるようになります。</p>
      <p>答えを確認する前に、<strong>MAP_DATAのいちばん左上を1→3に変えて実行してみてください。</strong>表示されたマップの左上が水に代わっていればOKです。</p>
      <div class="sourceCode" id="cb9" data-startFrom="1"
      data-caption="map03.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">import</span> os</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="im">import</span> tkinter <span class="im">as</span> tk</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="im">from</span> PIL <span class="im">import</span> Image,ImageTk</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt;&gt;ディレクトリ&gt;&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>cwd <span class="op">=</span> os.getcwd()</span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt;&gt;マップ設定&gt;&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>CHIP_SIZE <span class="op">=</span> <span class="dv">64</span> <span class="co">#マップチップの大きさ</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>X_MAPSIZE <span class="op">=</span> <span class="dv">20</span> <span class="co">#マップのx方向タイル数</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>Y_MAPSIZE <span class="op">=</span> <span class="dv">10</span> <span class="co">#マップのy方向タイル数</span></span>
<span id="cb9-12"><a href="#cb9-12"></a></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co">#&gt;&gt;ウィンドウ、キャンバス&gt;&gt;</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>CANVAS_WIDTH <span class="op">=</span> CHIP_SIZE <span class="op">*</span> X_MAPSIZE <span class="co">#キャンバス幅</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>CANVAS_HEIGHT <span class="op">=</span> CHIP_SIZE <span class="op">*</span> Y_MAPSIZE <span class="co">#キャンバス高さ</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>MARGINE_X <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>MARGINE_Y <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>CANVAS_SIZE <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>CANVAS_WIDTH<span class="op">+</span>MARGINE_X<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>CANVAS_HEIGHT<span class="op">+</span>MARGINE_Y<span class="sc">}</span><span class="ss">&quot;</span><span class="co">#キャンバスサイズ</span></span>
<span id="cb9-19"><a href="#cb9-19"></a></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co">#ウィンドウ設置</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>root <span class="op">=</span> tk.Tk()</span>
<span id="cb9-22"><a href="#cb9-22"></a>root.title(<span class="st">&quot;マップ表示&quot;</span>)</span>
<span id="cb9-23"><a href="#cb9-23"></a>root.geometry(CANVAS_SIZE)</span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="co">#キャンバス設置</span></span>
<span id="cb9-26"><a href="#cb9-26"></a>canvas <span class="op">=</span> tk.Canvas(root,width <span class="op">=</span> CANVAS_WIDTH,height <span class="op">=</span> CANVAS_HEIGHT,bg <span class="op">=</span> <span class="st">&quot;skyblue&quot;</span>)</span>
<span id="cb9-27"><a href="#cb9-27"></a>canvas.pack()</span>
<span id="cb9-28"><a href="#cb9-28"></a></span>
<span id="cb9-29"><a href="#cb9-29"></a></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="co">#&gt;&gt;マップチップ&gt;&gt;</span></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="co">#マップチップを1枚の画像に並べたマップシートを読み込む</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>MAP_SHEET <span class="op">=</span> Image.<span class="bu">open</span>(cwd<span class="op">+</span><span class="st">&quot;/img/sheet1.png&quot;</span>)</span>
<span id="cb9-33"><a href="#cb9-33"></a></span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="co">#読み込んだ画像から縦横何枚ずつチップがあるか求める</span></span>
<span id="cb9-35"><a href="#cb9-35"></a>CHIP_X <span class="op">=</span> MAP_SHEET.width <span class="op">//</span> CHIP_SIZE</span>
<span id="cb9-36"><a href="#cb9-36"></a>CHIP_Y <span class="op">=</span> MAP_SHEET.height <span class="op">//</span> CHIP_SIZE</span>
<span id="cb9-37"><a href="#cb9-37"></a></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="co">#マップシートをマップチップに分割し配列に格納する</span></span>
<span id="cb9-39"><a href="#cb9-39"></a>MAP_CHIP <span class="op">=</span> []</span>
<span id="cb9-40"><a href="#cb9-40"></a></span>
<span id="cb9-41"><a href="#cb9-41"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(CHIP_Y):</span>
<span id="cb9-42"><a href="#cb9-42"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(CHIP_X):</span>
<span id="cb9-43"><a href="#cb9-43"></a>        image <span class="op">=</span> ImageTk.PhotoImage(MAP_SHEET.crop((</span>
<span id="cb9-44"><a href="#cb9-44"></a>            CHIP_SIZE<span class="op">*</span>x , </span>
<span id="cb9-45"><a href="#cb9-45"></a>            CHIP_SIZE<span class="op">*</span>y , </span>
<span id="cb9-46"><a href="#cb9-46"></a>            CHIP_SIZE<span class="op">*</span>(x<span class="op">+</span><span class="dv">1</span>) , </span>
<span id="cb9-47"><a href="#cb9-47"></a>            CHIP_SIZE<span class="op">*</span>(y<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb9-48"><a href="#cb9-48"></a>            )))</span>
<span id="cb9-49"><a href="#cb9-49"></a>        MAP_CHIP.append(image)</span>
<span id="cb9-50"><a href="#cb9-50"></a></span>
<span id="cb9-51"><a href="#cb9-51"></a></span>
<span id="cb9-52"><a href="#cb9-52"></a><span class="co">#&gt;&gt;マップデータ&gt;&gt;</span></span>
<span id="cb9-53"><a href="#cb9-53"></a>MAP_DATA <span class="op">=</span> [</span>
<span id="cb9-54"><a href="#cb9-54"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-55"><a href="#cb9-55"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-56"><a href="#cb9-56"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-57"><a href="#cb9-57"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-58"><a href="#cb9-58"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-59"><a href="#cb9-59"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-60"><a href="#cb9-60"></a>    [<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-61"><a href="#cb9-61"></a>    [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-62"><a href="#cb9-62"></a>    [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-63"><a href="#cb9-63"></a>    [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>],</span>
<span id="cb9-64"><a href="#cb9-64"></a>]</span>
<span id="cb9-65"><a href="#cb9-65"></a></span>
<span id="cb9-66"><a href="#cb9-66"></a></span>
<span id="cb9-67"><a href="#cb9-67"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(Y_MAPSIZE):</span>
<span id="cb9-68"><a href="#cb9-68"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(X_MAPSIZE):</span>
<span id="cb9-69"><a href="#cb9-69"></a>        canvas.create_image(x<span class="op">*</span>CHIP_SIZE,y<span class="op">*</span>CHIP_SIZE,image <span class="op">=</span> MAP_CHIP[<span class="dv">1</span>] ,tag<span class="op">=</span><span class="ss">f&quot;chip</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">&quot;</span>,anchor<span class="op">=</span>tk.NW)</span>
<span id="cb9-70"><a href="#cb9-70"></a></span>
<span id="cb9-71"><a href="#cb9-71"></a>root.mainloop()</span></code></pre></div>
      <p><strong><i class="fa-solid fa-check"></i>解答</strong></p>
      <p><span
      class="masked"><code>image =MAP_CHIP[MAP_DATA[y][x]]</code></span></p>
      <hr />
      <p>これでデータをもとにマップチップを配置することができました！データを変更して、自由にマップを作ってみてください。</p>
      <p><br></p>
      <h1 data-number="8" id="さらに豪華なマップを作ろう"><span
      class="header-section-number">8</span>
      さらに豪華なマップを作ろう</h1>
      <p>「マップチップ　フリー」などで検索すると、マップチップのフリー素材を入手できます。それを活用すればさらに豪華なマップを作れます。
      おすすめのサイトを紹介します。</p>
      <ul>
      <li><a
      href="https://pipoya.net/sozai/assets/map-chip_tileset16/#マップセット１">マップチップ　16×16
      -ぴぽや倉庫</a></li>
      </ul>
      <p>使う際は入手した画像が何px四方なのかよく確認して、プログラムの<code>CHIP_SIZE</code>を変更してください。また、<strong>ゲームを公開したり配布する際は、使用する素材の規約をよく確認してください。</strong>ぜひ、楽しく自分でマップを作りこんでみてください！</p>
      <p><br></p>
      <hr />
      <p><br></p>
      <h1 data-number="9" id="キャラチップとは"><span
      class="header-section-number">9</span> キャラチップとは</h1>
      <p>ここからはキャラクターを操作するプログラムを実装していきます。</p>
      <p><strong>キャラチップ</strong>とは、ゲーム制作においてキャラクターのアニメーションを表現するための、複数のキャラクター画像が並べられた画像です。キャラクターチップとも呼ばれることがあります。</p>
      <figure>
      <img src="./figs/103/character.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ゲーム内では、プログラムでキャラチップの一部を切り出し、画面上に描画します。今回は、「どの方向を向いているか」に応じてキャラチップの行を、「移動の状態」に応じてキャラチップの列を選択して表示します。</p>
      <p>上の画像をダウンロードして<code>character.png</code>という名前で<code>img</code>フォルダに入れておいてください。</p>
      <p><br></p>
      <h1 data-number="10" id="キャラクターを表示させて移動する"><span
      class="header-section-number">10</span>
      キャラクターを表示させて移動する</h1>
      <p>新しいpythonファイル<code>move01.py</code>を作成してください。<a
      href="https://github.com/k-768/PythonGameProgramming/blob/main/programs/move01.py">ここから</a>プログラムをコピー＆ペーストして実行してみてください。<strong>WASDでキャラクターが移動します</strong>。このプログラムの要点について解説します。</p>
      <figure>
      <img src="./figs/103/walk.gif" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><br></p>
      <div class="sourceCode" id="cb10" data-startFrom="76"
      data-caption="move01（抜粋）.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 75;"><span id="cb10-76"><a href="#cb10-76"></a><span class="co">#&gt;&gt;キャラクター&gt;&gt;</span></span>
<span id="cb10-77"><a href="#cb10-77"></a>CHARA_WIDTH <span class="op">=</span> <span class="dv">64</span>  <span class="co">#キャラの幅</span></span>
<span id="cb10-78"><a href="#cb10-78"></a>CHARA_HEIGHT <span class="op">=</span> <span class="dv">96</span> <span class="co">#キャラの高さ</span></span>
<span id="cb10-79"><a href="#cb10-79"></a></span>
<span id="cb10-80"><a href="#cb10-80"></a><span class="co">#キャラクターのマップ座標</span></span>
<span id="cb10-81"><a href="#cb10-81"></a>charaX <span class="op">=</span> <span class="dv">2</span> </span>
<span id="cb10-82"><a href="#cb10-82"></a>charaY <span class="op">=</span> <span class="dv">2</span> </span>
<span id="cb10-83"><a href="#cb10-83"></a>charaD <span class="op">=</span> <span class="dv">1</span>  <span class="co">#キャラの向き</span></span>
<span id="cb10-84"><a href="#cb10-84"></a>flag <span class="op">=</span> <span class="st">&quot;default&quot;</span></span>
<span id="cb10-85"><a href="#cb10-85"></a><span class="co">&#39;&#39;&#39;</span></span>
<span id="cb10-86"><a href="#cb10-86"></a><span class="co">default:通常状態</span></span>
<span id="cb10-87"><a href="#cb10-87"></a><span class="co">move:移動中</span></span>
<span id="cb10-88"><a href="#cb10-88"></a><span class="co">&#39;&#39;&#39;</span></span></code></pre></div>
      <p><code>charaX</code>と<code>charaY</code>は、キャラクターの座標を示す変数です。しかしこれは普通のxy座標ではなく、マップ座標、つまり左上から<strong>何マス目</strong>かを示しています。
      <code>charaD</code>はキャラクタの方向を示す変数です。下向きが0、左向きが1、右向きが2、上向きが3と、キャラチップの並びと同じ順番になっています。</p>
      <figure>
      <img src="./figs/103/charaD.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><code>flag</code>は、魚を釣るプログラムでも登場した、場面を管理するためのものです。今回は待機中は<code>default</code>、移動中は<code>move</code>です。<strong>キーボードの入力は待機中のみ受け付け、移動中は受け付けません</strong>。</p>
      <p><br></p>
      <div class="sourceCode" id="cb11" data-startFrom="95"
      data-caption="move01（抜粋）.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 94;"><span id="cb11-95"><a href="#cb11-95"></a><span class="co">#移動方向</span></span>
<span id="cb11-96"><a href="#cb11-96"></a>moveX <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-97"><a href="#cb11-97"></a>moveY <span class="op">=</span> <span class="dv">0</span></span></code></pre></div>
      <p><code>moveX</code>、<code>moveY</code>は移動するマス目を示しています。たとえば、<code>moveX = -1</code>なら、<strong>1マス左に移動する</strong>ということになります。</p>
      <p><br></p>
      <div class="sourceCode" id="cb12" data-startFrom="99"
      data-caption="move01（抜粋）.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 98;"><span id="cb12-99"><a href="#cb12-99"></a><span class="co">#キャラチップを1毎の画像に並べたキャラシートを読み込む</span></span>
<span id="cb12-100"><a href="#cb12-100"></a>CHARA_SHEET <span class="op">=</span> Image.<span class="bu">open</span>(cwd<span class="op">+</span><span class="st">&quot;/img/character.png&quot;</span>)</span>
<span id="cb12-101"><a href="#cb12-101"></a></span>
<span id="cb12-102"><a href="#cb12-102"></a><span class="co">#読み込んだ画像から縦横何枚ずつチップがあるか求める</span></span>
<span id="cb12-103"><a href="#cb12-103"></a>CHARA_X <span class="op">=</span> CHARA_SHEET.width <span class="op">//</span> CHARA_WIDTH</span>
<span id="cb12-104"><a href="#cb12-104"></a>CHARA_Y <span class="op">=</span> CHARA_SHEET.height <span class="op">//</span> CHARA_HEIGHT</span>
<span id="cb12-105"><a href="#cb12-105"></a></span>
<span id="cb12-106"><a href="#cb12-106"></a></span>
<span id="cb12-107"><a href="#cb12-107"></a><span class="co">#キャラチップに分割し2次元配列に格納する</span></span>
<span id="cb12-108"><a href="#cb12-108"></a>CHARA_CHIP <span class="op">=</span> []</span>
<span id="cb12-109"><a href="#cb12-109"></a><span class="co">#キャラシートの列数だけ繰り返す</span></span>
<span id="cb12-110"><a href="#cb12-110"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(CHARA_Y): </span>
<span id="cb12-111"><a href="#cb12-111"></a>    <span class="co">#新しい行を作成</span></span>
<span id="cb12-112"><a href="#cb12-112"></a>    row <span class="op">=</span> []</span>
<span id="cb12-113"><a href="#cb12-113"></a>    </span>
<span id="cb12-114"><a href="#cb12-114"></a>    <span class="co">#キャラシートの行数だけ繰り返す</span></span>
<span id="cb12-115"><a href="#cb12-115"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(CHARA_X): </span>
<span id="cb12-116"><a href="#cb12-116"></a>        <span class="co"># キャラクターのチップを切り出して画像を作成</span></span>
<span id="cb12-117"><a href="#cb12-117"></a>        image <span class="op">=</span> ImageTk.PhotoImage(CHARA_SHEET.crop((</span>
<span id="cb12-118"><a href="#cb12-118"></a>            CHARA_WIDTH <span class="op">*</span> i,               <span class="co"># 左上のX座標</span></span>
<span id="cb12-119"><a href="#cb12-119"></a>            CHARA_HEIGHT <span class="op">*</span> j,              <span class="co"># 左上のY座標</span></span>
<span id="cb12-120"><a href="#cb12-120"></a>            CHARA_WIDTH <span class="op">*</span> (i <span class="op">+</span> <span class="dv">1</span>),         <span class="co"># 右下のX座標</span></span>
<span id="cb12-121"><a href="#cb12-121"></a>            CHARA_HEIGHT <span class="op">*</span> (j <span class="op">+</span> <span class="dv">1</span>)         <span class="co"># 右下のY座標</span></span>
<span id="cb12-122"><a href="#cb12-122"></a>        )))</span>
<span id="cb12-123"><a href="#cb12-123"></a>        </span>
<span id="cb12-124"><a href="#cb12-124"></a>        <span class="co"># 作成した画像を行に追加</span></span>
<span id="cb12-125"><a href="#cb12-125"></a>        row.append(image)</span>
<span id="cb12-126"><a href="#cb12-126"></a>    </span>
<span id="cb12-127"><a href="#cb12-127"></a>    <span class="co"># 行をCHARA_CHIPに追加</span></span>
<span id="cb12-128"><a href="#cb12-128"></a>    CHARA_CHIP.append(row)</span></code></pre></div>
      <p><code>99行目</code>からはキャラチップの画像を、マップチップとほとんど同じ方法で取得しています。
      ただし、マップチップはリストに格納していましたが、<strong>キャラチップは2次元リストに格納しています</strong>。</p>
      <hr />
      <ul>
      <li><strong>ChallengeA4-1</strong>　<code>CHARA_CHIP[1][2]</code>はどこの部分を指しますか。</li>
      </ul>
      <figure>
      <img src="./figs/103/character.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>回答はコラムの後にあります。</p>
      <div class="note type-tips">
      <p><strong>リストの内包表記</strong></p>
      <p>Pythonの便利な文法の一つに<strong>内包表記</strong>というものがあります。<strong>「リストを簡単に作れる書き方」</strong>です。</p>
      <div class="sourceCode" id="cb13" data-startFrom="1"
      data-caption="リストの内包表記"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>CHARA_CHIP <span class="op">=</span> [</span>
<span id="cb13-2"><a href="#cb13-2"></a>    [</span>
<span id="cb13-3"><a href="#cb13-3"></a>        ImageTk.PhotoImage(CHARA_SHEET.crop((</span>
<span id="cb13-4"><a href="#cb13-4"></a>            CHARA_WIDTH <span class="op">*</span> i,</span>
<span id="cb13-5"><a href="#cb13-5"></a>            CHARA_HEIGHT <span class="op">*</span> j,</span>
<span id="cb13-6"><a href="#cb13-6"></a>            CHARA_WIDTH <span class="op">*</span> (i <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb13-7"><a href="#cb13-7"></a>            CHARA_HEIGHT <span class="op">*</span> (j <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb13-8"><a href="#cb13-8"></a>            ))) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(CHARA_X)</span>
<span id="cb13-9"><a href="#cb13-9"></a>        ]<span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(CHARA_Y)</span>
<span id="cb13-10"><a href="#cb13-10"></a>    ]</span></code></pre></div>
      <div class="sourceCode" id="cb14" data-startFrom="1"
      data-caption="リストの内包表記を使わない場合"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>CHARA_CHIP <span class="op">=</span> []</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co">#キャラシートの列数だけ繰り返す</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(CHARA_Y): </span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="co">#新しい行を作成</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    row <span class="op">=</span> []</span>
<span id="cb14-6"><a href="#cb14-6"></a>    </span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="co">#キャラシートの行数だけ繰り返す</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(CHARA_X): </span>
<span id="cb14-9"><a href="#cb14-9"></a>        <span class="co"># キャラクターのチップを切り出して画像を作成</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>        image <span class="op">=</span> ImageTk.PhotoImage(CHARA_SHEET.crop((</span>
<span id="cb14-11"><a href="#cb14-11"></a>            CHARA_WIDTH <span class="op">*</span> i,               <span class="co"># 左上のX座標</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>            CHARA_HEIGHT <span class="op">*</span> j,              <span class="co"># 左上のY座標</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>            CHARA_WIDTH <span class="op">*</span> (i <span class="op">+</span> <span class="dv">1</span>),         <span class="co"># 右下のX座標</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>            CHARA_HEIGHT <span class="op">*</span> (j <span class="op">+</span> <span class="dv">1</span>)         <span class="co"># 右下のY座標</span></span>
<span id="cb14-15"><a href="#cb14-15"></a>        )))</span>
<span id="cb14-16"><a href="#cb14-16"></a>        </span>
<span id="cb14-17"><a href="#cb14-17"></a>        <span class="co"># 作成した画像を行に追加</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>        row.append(image)</span>
<span id="cb14-19"><a href="#cb14-19"></a>    </span>
<span id="cb14-20"><a href="#cb14-20"></a>    <span class="co"># 行をCHARA_CHIPに追加</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>    CHARA_CHIP.append(row)</span></code></pre></div>
      <p>このように、同じ処理でも簡単に記述できます。リストの内包表記をざっくり説明すると、ループを使ってリストを作るコードを1行にまとめる方法です。しかし、少し理解が難しいので今回は扱いません。気になった方は自分で調べてみてください。</p>
      </div>
      <p><strong><i class="fa-solid fa-check"></i>解答</strong></p>
      <figure>
      <img src="./figs/103/ans.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><br></p>
      <hr />
      <p>プログラムの解説に戻ります。</p>
      <div class="sourceCode" id="cb15" data-startFrom="150"
      data-caption="move01.py（抜粋）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 149;"><span id="cb15-150"><a href="#cb15-150"></a><span class="co">#&gt;&gt;ゲームのメインループ関数&gt;&gt;</span></span>
<span id="cb15-151"><a href="#cb15-151"></a><span class="kw">def</span> gameLoop():</span>
<span id="cb15-152"><a href="#cb15-152"></a>    <span class="kw">global</span> charaX,charaY,charaD,moveCount,moveX,moveY,flag,key,currentKey,prevKey</span>
<span id="cb15-153"><a href="#cb15-153"></a>    </span>
<span id="cb15-154"><a href="#cb15-154"></a>    <span class="cf">if</span> <span class="bu">len</span>(key)<span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb15-155"><a href="#cb15-155"></a>        lastKey <span class="op">=</span> key[<span class="bu">len</span>(key) <span class="op">-</span> <span class="dv">1</span>] <span class="co">#最後に押されたキー</span></span>
<span id="cb15-156"><a href="#cb15-156"></a>    <span class="cf">else</span>:</span>
<span id="cb15-157"><a href="#cb15-157"></a>        lastKey <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb15-158"><a href="#cb15-158"></a>    </span>
<span id="cb15-159"><a href="#cb15-159"></a>    </span>
<span id="cb15-160"><a href="#cb15-160"></a>    <span class="cf">if</span> flag <span class="op">==</span> <span class="st">&quot;default&quot;</span>: <span class="co">#待機中のとき </span></span>
<span id="cb15-161"><a href="#cb15-161"></a>        </span>
<span id="cb15-162"><a href="#cb15-162"></a>        <span class="cf">if</span> <span class="bu">len</span>(key): <span class="co">#何かのキーが押されているとき</span></span>
<span id="cb15-163"><a href="#cb15-163"></a>            <span class="cf">if</span> lastKey<span class="op">==</span><span class="st">&quot;s&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Down&quot;</span>:<span class="co">#下入力</span></span>
<span id="cb15-164"><a href="#cb15-164"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb15-165"><a href="#cb15-165"></a>                charaD <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-166"><a href="#cb15-166"></a>                moveX <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-167"><a href="#cb15-167"></a>                moveY <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb15-168"><a href="#cb15-168"></a>                <span class="bu">print</span>(<span class="st">&quot;↓&quot;</span>)</span>
<span id="cb15-169"><a href="#cb15-169"></a>            <span class="cf">elif</span> lastKey<span class="op">==</span><span class="st">&quot;a&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Left&quot;</span>:<span class="co">#左入力</span></span>
<span id="cb15-170"><a href="#cb15-170"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb15-171"><a href="#cb15-171"></a>                charaD <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb15-172"><a href="#cb15-172"></a>                moveX <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb15-173"><a href="#cb15-173"></a>                moveY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-174"><a href="#cb15-174"></a>                <span class="bu">print</span>(<span class="st">&quot;←&quot;</span>)</span>
<span id="cb15-175"><a href="#cb15-175"></a>            <span class="cf">elif</span> lastKey<span class="op">==</span><span class="st">&quot;d&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Right&quot;</span>:<span class="co">#右入力</span></span>
<span id="cb15-176"><a href="#cb15-176"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb15-177"><a href="#cb15-177"></a>                charaD <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb15-178"><a href="#cb15-178"></a>                moveX <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb15-179"><a href="#cb15-179"></a>                moveY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-180"><a href="#cb15-180"></a>                <span class="bu">print</span>(<span class="st">&quot;→&quot;</span>)</span>
<span id="cb15-181"><a href="#cb15-181"></a>            <span class="cf">elif</span> lastKey<span class="op">==</span><span class="st">&quot;w&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Up&quot;</span>:<span class="co">#上入力</span></span>
<span id="cb15-182"><a href="#cb15-182"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb15-183"><a href="#cb15-183"></a>                charaD <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb15-184"><a href="#cb15-184"></a>                moveX <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-185"><a href="#cb15-185"></a>                moveY <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb15-186"><a href="#cb15-186"></a>                <span class="bu">print</span>(<span class="st">&quot;↑&quot;</span>)</span>
<span id="cb15-187"><a href="#cb15-187"></a>    </span>
<span id="cb15-188"><a href="#cb15-188"></a>    <span class="cf">if</span> flag <span class="op">==</span> <span class="st">&quot;move&quot;</span>:<span class="co">#移動中のとき</span></span>
<span id="cb15-189"><a href="#cb15-189"></a>        flag <span class="op">=</span> <span class="st">&quot;default&quot;</span><span class="co">#待機中に状態を戻す</span></span>
<span id="cb15-190"><a href="#cb15-190"></a>        charaX <span class="op">+=</span> moveX</span>
<span id="cb15-191"><a href="#cb15-191"></a>        charaY <span class="op">+=</span> moveY</span>
<span id="cb15-192"><a href="#cb15-192"></a>        <span class="co">#キャラクター再描写</span></span>
<span id="cb15-193"><a href="#cb15-193"></a>        setChara(charaX,charaY,charaD)</span></code></pre></div>
      <p>ゲームの処理は、関数<code>gameLoop</code>内にあります。if文を用いて、<strong>移動用のキーが押されたかを判定</strong>し、<strong>進む方向によって<code>moveX</code>と<code>moveY</code>を変更</strong>します。また、<code>flag</code>を<strong>moveに変更</strong>します。
      キーが押されて移動中になったら、今度はキャラクターの位置を進行方向に一つ進んだ位置に変更し、<code>flag</code>を<strong>defaultに戻し</strong>ます。今は<code>flag</code>が必要ないように感じると思いますが、アニメーションを行う際に必要になります。</p>
      <p>これで、作成したマップの上を、キーボードの操作でキャラクターを移動させることができるようになりました。</p>
      <p>しかし、直立不動で移動していたり、水の上を歩いていたりと、このままではおかしなところがたくさんあります。</p>
      <figure>
      <img src="./figs/103/walk.gif" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>まずは水の上には侵入できないようにしましょう。</p>
      <p><br></p>
      <h1 data-number="11" id="水の中には入れないようにする"><span
      class="header-section-number">11</span>
      水の中には入れないようにする</h1>
      <p>はじめに、各マップチップに対して、入れるかどうかを設定しましょう。
      マップのリストの後ろに以下を追加してください。</p>
      <div class="sourceCode" id="cb16" data-startFrom="67"
      data-caption="move02.py（追加）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 66;"><span id="cb16-67"><a href="#cb16-67"></a><span class="co">#通行許可設定</span></span>
<span id="cb16-68"><a href="#cb16-68"></a><span class="co">#0:不可</span></span>
<span id="cb16-69"><a href="#cb16-69"></a><span class="co">#1:可能</span></span>
<span id="cb16-70"><a href="#cb16-70"></a>PASSAGE_PERMIT <span class="op">=</span> [<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>]</span></code></pre></div>
      <p>この配列は、<code>CHIP_DATA</code>の順番と対応しています。</p>
      <figure>
      <img src="./figs/103/sheet1.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>つまり、マップチップの左から侵入「不可」「可」「可」「不可」となり、草地と砂地は侵入できることになります。</p>
      <p><br></p>
      <p>この設定を使って、<strong>移動する前に</strong>判定を行います。</p>
      <p><strong>!!!!ここから追加する!!!!</strong>と書かれたところからのプログラムを追加してください。
      追加する際、インデントに注意してください。</p>
      <div class="sourceCode" id="cb17" data-startFrom="155"
      data-caption="move02.py（追加）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 154;"><span id="cb17-155"><a href="#cb17-155"></a><span class="kw">def</span> gameLoop():</span>
<span id="cb17-156"><a href="#cb17-156"></a>    <span class="kw">global</span> charaX,charaY,charaD,moveCount,moveX,moveY,flag,key,currentKey,prevKey</span>
<span id="cb17-157"><a href="#cb17-157"></a>    </span>
<span id="cb17-158"><a href="#cb17-158"></a>    <span class="cf">if</span> <span class="bu">len</span>(key)<span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-159"><a href="#cb17-159"></a>        lastKey <span class="op">=</span> key[<span class="bu">len</span>(key) <span class="op">-</span> <span class="dv">1</span>] <span class="co">#最後に押されたキー</span></span>
<span id="cb17-160"><a href="#cb17-160"></a>    <span class="cf">else</span>:</span>
<span id="cb17-161"><a href="#cb17-161"></a>        lastKey <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb17-162"><a href="#cb17-162"></a>    </span>
<span id="cb17-163"><a href="#cb17-163"></a>    </span>
<span id="cb17-164"><a href="#cb17-164"></a>    <span class="cf">if</span> flag <span class="op">==</span> <span class="st">&quot;default&quot;</span>: <span class="co">#待機中のとき </span></span>
<span id="cb17-165"><a href="#cb17-165"></a>        </span>
<span id="cb17-166"><a href="#cb17-166"></a>        <span class="cf">if</span> <span class="bu">len</span>(key): <span class="co">#何かのキーが押されているとき</span></span>
<span id="cb17-167"><a href="#cb17-167"></a>            <span class="cf">if</span> lastKey<span class="op">==</span><span class="st">&quot;s&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Down&quot;</span>:<span class="co">#下入力</span></span>
<span id="cb17-168"><a href="#cb17-168"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb17-169"><a href="#cb17-169"></a>                charaD <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-170"><a href="#cb17-170"></a>                moveX <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-171"><a href="#cb17-171"></a>                moveY <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-172"><a href="#cb17-172"></a>                <span class="bu">print</span>(<span class="st">&quot;↓&quot;</span>)</span>
<span id="cb17-173"><a href="#cb17-173"></a>            <span class="cf">elif</span> lastKey<span class="op">==</span><span class="st">&quot;a&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Left&quot;</span>:<span class="co">#左入力</span></span>
<span id="cb17-174"><a href="#cb17-174"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb17-175"><a href="#cb17-175"></a>                charaD <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-176"><a href="#cb17-176"></a>                moveX <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb17-177"><a href="#cb17-177"></a>                moveY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-178"><a href="#cb17-178"></a>                <span class="bu">print</span>(<span class="st">&quot;←&quot;</span>)</span>
<span id="cb17-179"><a href="#cb17-179"></a>            <span class="cf">elif</span> lastKey<span class="op">==</span><span class="st">&quot;d&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Right&quot;</span>:<span class="co">#右入力</span></span>
<span id="cb17-180"><a href="#cb17-180"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb17-181"><a href="#cb17-181"></a>                charaD <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb17-182"><a href="#cb17-182"></a>                moveX <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-183"><a href="#cb17-183"></a>                moveY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-184"><a href="#cb17-184"></a>                <span class="bu">print</span>(<span class="st">&quot;→&quot;</span>)</span>
<span id="cb17-185"><a href="#cb17-185"></a>            <span class="cf">elif</span> lastKey<span class="op">==</span><span class="st">&quot;w&quot;</span> <span class="kw">or</span> lastKey<span class="op">==</span><span class="st">&quot;Up&quot;</span>:<span class="co">#上入力</span></span>
<span id="cb17-186"><a href="#cb17-186"></a>                flag <span class="op">=</span> <span class="st">&quot;move&quot;</span></span>
<span id="cb17-187"><a href="#cb17-187"></a>                charaD <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb17-188"><a href="#cb17-188"></a>                moveX <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-189"><a href="#cb17-189"></a>                moveY <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb17-190"><a href="#cb17-190"></a>                <span class="bu">print</span>(<span class="st">&quot;↑&quot;</span>)</span>
<span id="cb17-191"><a href="#cb17-191"></a>            </span>
<span id="cb17-192"><a href="#cb17-192"></a>            <span class="co">#!!!!ここから追加する!!!#</span></span>
<span id="cb17-193"><a href="#cb17-193"></a></span>
<span id="cb17-194"><a href="#cb17-194"></a>            <span class="co">#上の処理で移動中フラグが立ったとき</span></span>
<span id="cb17-195"><a href="#cb17-195"></a>            <span class="cf">if</span> flag <span class="op">==</span> <span class="st">&quot;move&quot;</span>:</span>
<span id="cb17-196"><a href="#cb17-196"></a>                <span class="co">#移動先が通行可能でないならば</span></span>
<span id="cb17-197"><a href="#cb17-197"></a>                <span class="cf">if</span> <span class="kw">not</span> PASSAGE_PERMIT[MAP_DATA[charaY<span class="op">+</span>moveY][charaX<span class="op">+</span>moveX]]:</span>
<span id="cb17-198"><a href="#cb17-198"></a>                    <span class="co">#移動をやめて向きのみ変える</span></span>
<span id="cb17-199"><a href="#cb17-199"></a>                    flag <span class="op">=</span> <span class="st">&quot;default&quot;</span></span>
<span id="cb17-200"><a href="#cb17-200"></a>                    moveX <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-201"><a href="#cb17-201"></a>                    moveY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-202"><a href="#cb17-202"></a>                    setChara(charaX,charaY,charaD)</span></code></pre></div>
      <p><code>MAP_DATA[charaY+moveY][charaX+moveX]</code>が移動する先のマップの情報(1なら草地、2なら砂地…)です。それを<code>PASSAGE_PERMIT</code>に入れることで、<strong>移動先のマップチップが、上を歩ける種類かどうか判定できます</strong></p>
      <p>移動先が侵入できない場合、<code>flag</code>を<strong>defaultに戻します</strong>。ただし、向きだけは変えたいので関数<code>setChara()</code>でキャラクターを更新しています。</p>
      <p><br></p>
      <h1 data-number="12" id="キャラクターをアニメーションさせる"><span
      class="header-section-number">12</span>
      キャラクターをアニメーションさせる</h1>
      <p>次に、キャラクターに歩行アニメーションをつけてみましょう。
      キャラクターが歩いているように見せるためには、図のような順番で表示する必要があります。</p>
      <figure>
      <img src="./figs/103/walk2.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>これを<strong>index</strong>で表すと、0→1→2→1となります。そこで<code>FRAME_LIST = [0,1,2,1]</code>とおき、これを参照することにします。新しいpythonファイル<code>move03.py</code>を作成してください。</p>
      <div class="sourceCode" id="cb18" data-startFrom="1"
      data-caption="move03.py"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="im">import</span> os</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="im">import</span> tkinter <span class="im">as</span> tk</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="im">from</span> PIL <span class="im">import</span> Image,ImageTk</span>
<span id="cb18-4"><a href="#cb18-4"></a></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co">#&gt;&gt;ディレクトリ&gt;&gt;</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>cwd <span class="op">=</span> os.getcwd()</span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co">#&gt;&gt;ウィンドウ、キャンバス&gt;&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>CANVAS_WIDTH <span class="op">=</span> <span class="dv">160</span> <span class="co">#キャンバス幅</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>CANVAS_HEIGHT <span class="op">=</span> <span class="dv">200</span> <span class="co">#キャンバス高さ</span></span>
<span id="cb18-12"><a href="#cb18-12"></a>MARGINE_X <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb18-13"><a href="#cb18-13"></a>MARGINE_Y <span class="op">=</span> <span class="dv">2</span> <span class="co">#マージン</span></span>
<span id="cb18-14"><a href="#cb18-14"></a>CANVAS_SIZE <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>CANVAS_WIDTH<span class="op">+</span>MARGINE_X<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>CANVAS_HEIGHT<span class="op">+</span>MARGINE_Y<span class="sc">}</span><span class="ss">&quot;</span><span class="co">#キャンバスサイズ</span></span>
<span id="cb18-15"><a href="#cb18-15"></a></span>
<span id="cb18-16"><a href="#cb18-16"></a><span class="co">#ウィンドウ設置</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>root <span class="op">=</span> tk.Tk()</span>
<span id="cb18-18"><a href="#cb18-18"></a>root.title(<span class="st">&quot;アニメーション&quot;</span>)</span>
<span id="cb18-19"><a href="#cb18-19"></a>root.geometry(CANVAS_SIZE)</span>
<span id="cb18-20"><a href="#cb18-20"></a></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="co">#キャンバス設置</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>canvas <span class="op">=</span> tk.Canvas(root,width <span class="op">=</span> CANVAS_WIDTH,height <span class="op">=</span> CANVAS_HEIGHT,bg <span class="op">=</span> <span class="st">&quot;skyblue&quot;</span>)</span>
<span id="cb18-23"><a href="#cb18-23"></a>canvas.pack()</span>
<span id="cb18-24"><a href="#cb18-24"></a></span>
<span id="cb18-25"><a href="#cb18-25"></a></span>
<span id="cb18-26"><a href="#cb18-26"></a><span class="co">#&gt;&gt;キャラクター&gt;&gt;</span></span>
<span id="cb18-27"><a href="#cb18-27"></a>CHARA_WIDTH <span class="op">=</span> <span class="dv">64</span>  <span class="co">#キャラの幅</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>CHARA_HEIGHT <span class="op">=</span> <span class="dv">96</span> <span class="co">#キャラの高さ</span></span>
<span id="cb18-29"><a href="#cb18-29"></a></span>
<span id="cb18-30"><a href="#cb18-30"></a><span class="co">#キャラクターの座標</span></span>
<span id="cb18-31"><a href="#cb18-31"></a>charaX <span class="op">=</span> <span class="dv">60</span> </span>
<span id="cb18-32"><a href="#cb18-32"></a>charaY <span class="op">=</span> <span class="dv">60</span> </span>
<span id="cb18-33"><a href="#cb18-33"></a>charaD <span class="op">=</span> <span class="dv">1</span>  <span class="co">#キャラの向き</span></span>
<span id="cb18-34"><a href="#cb18-34"></a>FRAME_LIST <span class="op">=</span> [<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>]</span>
<span id="cb18-35"><a href="#cb18-35"></a></span>
<span id="cb18-36"><a href="#cb18-36"></a>moveCount <span class="op">=</span> <span class="dv">0</span>    <span class="co">#移動カウンタ 0から3の4段階</span></span>
<span id="cb18-37"><a href="#cb18-37"></a></span>
<span id="cb18-38"><a href="#cb18-38"></a><span class="co">#ゲームの基本となる1ティック時間(ms)</span></span>
<span id="cb18-39"><a href="#cb18-39"></a>TICK_TIME <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb18-40"><a href="#cb18-40"></a></span>
<span id="cb18-41"><a href="#cb18-41"></a><span class="co">#キャラチップを1毎の画像に並べたキャラシートを読み込む</span></span>
<span id="cb18-42"><a href="#cb18-42"></a>CHARA_SHEET <span class="op">=</span> Image.<span class="bu">open</span>(cwd<span class="op">+</span><span class="st">&quot;/img/character.png&quot;</span>)</span>
<span id="cb18-43"><a href="#cb18-43"></a></span>
<span id="cb18-44"><a href="#cb18-44"></a><span class="co">#読み込んだ画像から縦横何枚ずつチップがあるか求める</span></span>
<span id="cb18-45"><a href="#cb18-45"></a>CHARA_X <span class="op">=</span> CHARA_SHEET.width <span class="op">//</span> CHARA_WIDTH</span>
<span id="cb18-46"><a href="#cb18-46"></a>CHARA_Y <span class="op">=</span> CHARA_SHEET.height <span class="op">//</span> CHARA_HEIGHT</span>
<span id="cb18-47"><a href="#cb18-47"></a></span>
<span id="cb18-48"><a href="#cb18-48"></a></span>
<span id="cb18-49"><a href="#cb18-49"></a><span class="co">#キャラチップに分割し2次元配列に格納する</span></span>
<span id="cb18-50"><a href="#cb18-50"></a>CHARA_CHIP <span class="op">=</span> []</span>
<span id="cb18-51"><a href="#cb18-51"></a><span class="co">#キャラシートの列数だけ繰り返す</span></span>
<span id="cb18-52"><a href="#cb18-52"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(CHARA_Y): </span>
<span id="cb18-53"><a href="#cb18-53"></a>    <span class="co">#新しい行を作成</span></span>
<span id="cb18-54"><a href="#cb18-54"></a>    row <span class="op">=</span> []</span>
<span id="cb18-55"><a href="#cb18-55"></a>    </span>
<span id="cb18-56"><a href="#cb18-56"></a>    <span class="co">#キャラシートの行数だけ繰り返す</span></span>
<span id="cb18-57"><a href="#cb18-57"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(CHARA_X): </span>
<span id="cb18-58"><a href="#cb18-58"></a>        <span class="co"># キャラクターのチップを切り出して画像を作成</span></span>
<span id="cb18-59"><a href="#cb18-59"></a>        image <span class="op">=</span> ImageTk.PhotoImage(CHARA_SHEET.crop((</span>
<span id="cb18-60"><a href="#cb18-60"></a>            CHARA_WIDTH <span class="op">*</span> i,               <span class="co"># 左上のX座標</span></span>
<span id="cb18-61"><a href="#cb18-61"></a>            CHARA_HEIGHT <span class="op">*</span> j,              <span class="co"># 左上のY座標</span></span>
<span id="cb18-62"><a href="#cb18-62"></a>            CHARA_WIDTH <span class="op">*</span> (i <span class="op">+</span> <span class="dv">1</span>),         <span class="co"># 右下のX座標</span></span>
<span id="cb18-63"><a href="#cb18-63"></a>            CHARA_HEIGHT <span class="op">*</span> (j <span class="op">+</span> <span class="dv">1</span>)         <span class="co"># 右下のY座標</span></span>
<span id="cb18-64"><a href="#cb18-64"></a>        )))</span>
<span id="cb18-65"><a href="#cb18-65"></a>        </span>
<span id="cb18-66"><a href="#cb18-66"></a>        <span class="co"># 作成した画像を行に追加</span></span>
<span id="cb18-67"><a href="#cb18-67"></a>        row.append(image)</span>
<span id="cb18-68"><a href="#cb18-68"></a>    </span>
<span id="cb18-69"><a href="#cb18-69"></a>    <span class="co"># 行をCHARA_CHIPに追加</span></span>
<span id="cb18-70"><a href="#cb18-70"></a>    CHARA_CHIP.append(row)</span>
<span id="cb18-71"><a href="#cb18-71"></a></span>
<span id="cb18-72"><a href="#cb18-72"></a></span>
<span id="cb18-73"><a href="#cb18-73"></a><span class="co">#キャラクターを再描写する関数</span></span>
<span id="cb18-74"><a href="#cb18-74"></a><span class="kw">def</span> setChara(x,y,d,frame):</span>
<span id="cb18-75"><a href="#cb18-75"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb18-76"><a href="#cb18-76"></a><span class="co">    x:キャラのX座標</span></span>
<span id="cb18-77"><a href="#cb18-77"></a><span class="co">    y:キャラのY座標</span></span>
<span id="cb18-78"><a href="#cb18-78"></a><span class="co">    d:キャラの向き</span></span>
<span id="cb18-79"><a href="#cb18-79"></a><span class="co">    frame:コマ数</span></span>
<span id="cb18-80"><a href="#cb18-80"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb18-81"><a href="#cb18-81"></a>    <span class="co">#キャラの画像を選択</span></span>
<span id="cb18-82"><a href="#cb18-82"></a>    img <span class="op">=</span> CHARA_CHIP[d][FRAME_LIST[frame]]</span>
<span id="cb18-83"><a href="#cb18-83"></a>    </span>
<span id="cb18-84"><a href="#cb18-84"></a>    <span class="co">#今の画像を消して再描写</span></span>
<span id="cb18-85"><a href="#cb18-85"></a>    canvas.delete(<span class="st">&quot;chara&quot;</span>)</span>
<span id="cb18-86"><a href="#cb18-86"></a>    canvas.create_image(x,y,image <span class="op">=</span>img ,tag<span class="op">=</span><span class="st">&quot;chara&quot;</span>,anchor<span class="op">=</span>tk.NW)</span>
<span id="cb18-87"><a href="#cb18-87"></a></span>
<span id="cb18-88"><a href="#cb18-88"></a></span>
<span id="cb18-89"><a href="#cb18-89"></a><span class="co">#&gt;&gt;ゲームのメインループ関数&gt;&gt;</span></span>
<span id="cb18-90"><a href="#cb18-90"></a><span class="kw">def</span> gameLoop():</span>
<span id="cb18-91"><a href="#cb18-91"></a>    <span class="kw">global</span> charaX,charaY,charaD,moveCount</span>
<span id="cb18-92"><a href="#cb18-92"></a>    </span>
<span id="cb18-93"><a href="#cb18-93"></a>    setChara(charaX,charaY,charaD,moveCount)</span>
<span id="cb18-94"><a href="#cb18-94"></a>    </span>
<span id="cb18-95"><a href="#cb18-95"></a>    <span class="cf">if</span> moveCount<span class="op">==</span><span class="dv">3</span>:<span class="co">#アニメーションが最終コマならば</span></span>
<span id="cb18-96"><a href="#cb18-96"></a>        moveCount <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-97"><a href="#cb18-97"></a>    <span class="cf">else</span>:</span>
<span id="cb18-98"><a href="#cb18-98"></a>        moveCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-99"><a href="#cb18-99"></a>    </span>
<span id="cb18-100"><a href="#cb18-100"></a>    root.after(TICK_TIME,gameLoop)</span>
<span id="cb18-101"><a href="#cb18-101"></a></span>
<span id="cb18-102"><a href="#cb18-102"></a>setChara(charaX,charaY,charaD,<span class="dv">1</span>)</span>
<span id="cb18-103"><a href="#cb18-103"></a></span>
<span id="cb18-104"><a href="#cb18-104"></a>gameLoop()</span>
<span id="cb18-105"><a href="#cb18-105"></a><span class="bu">print</span>(<span class="st">&quot;start!&quot;</span>)</span>
<span id="cb18-106"><a href="#cb18-106"></a>root.mainloop()</span></code></pre></div>
      <p>実行するとキャラクターが歩き出します。</p>
      <figure>
      <img src="./figs/103/walk_anime.gif" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><br></p>
      <p>ポイントは、<strong><code>moveCount</code>を1ずつ増やしていき、3まで増えたら0に戻ることです</strong>。<code>moveCount</code>は0→1→2→3→0→1→…と繰り返します。</p>
      <div class="sourceCode" id="cb19" data-startFrom="89"
      data-caption="move03.py（抜粋）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 88;"><span id="cb19-89"><a href="#cb19-89"></a><span class="co">#&gt;&gt;ゲームのメインループ関数&gt;&gt;</span></span>
<span id="cb19-90"><a href="#cb19-90"></a><span class="kw">def</span> gameLoop():</span>
<span id="cb19-91"><a href="#cb19-91"></a>    <span class="kw">global</span> charaX,charaY,charaD,moveCount</span>
<span id="cb19-92"><a href="#cb19-92"></a>    </span>
<span id="cb19-93"><a href="#cb19-93"></a>    setChara(charaX,charaY,charaD,moveCount)</span>
<span id="cb19-94"><a href="#cb19-94"></a>    </span>
<span id="cb19-95"><a href="#cb19-95"></a>    <span class="cf">if</span> moveCount<span class="op">==</span><span class="dv">3</span>:<span class="co">#アニメーションが最終コマならば</span></span>
<span id="cb19-96"><a href="#cb19-96"></a>        moveCount <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-97"><a href="#cb19-97"></a>    <span class="cf">else</span>:</span>
<span id="cb19-98"><a href="#cb19-98"></a>        moveCount <span class="op">+=</span> <span class="dv">1</span></span></code></pre></div>
      <p><br></p>
      <p>そして<code>CHARA_CHIP</code>の2つめの引数に<code>FRAME_LIST[frame]</code>を指定することでアニメーションさせます。</p>
      <div class="sourceCode" id="cb20" data-startFrom="73"
      data-caption="move03.py（抜粋）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 72;"><span id="cb20-73"><a href="#cb20-73"></a><span class="co">#キャラクターを再描写する関数</span></span>
<span id="cb20-74"><a href="#cb20-74"></a><span class="kw">def</span> setChara(x,y,d,frame):</span>
<span id="cb20-75"><a href="#cb20-75"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-76"><a href="#cb20-76"></a><span class="co">    x:キャラのX座標</span></span>
<span id="cb20-77"><a href="#cb20-77"></a><span class="co">    y:キャラのY座標</span></span>
<span id="cb20-78"><a href="#cb20-78"></a><span class="co">    d:キャラの向き</span></span>
<span id="cb20-79"><a href="#cb20-79"></a><span class="co">    frame:コマ数</span></span>
<span id="cb20-80"><a href="#cb20-80"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb20-81"><a href="#cb20-81"></a>    <span class="co">#キャラの画像を選択</span></span>
<span id="cb20-82"><a href="#cb20-82"></a>    img <span class="op">=</span> CHARA_CHIP[d][FRAME_LIST[frame]]</span></code></pre></div>
      <p><br></p>
      <h1 data-number="13" id="組み合わせる"><span
      class="header-section-number">13</span> 組み合わせる</h1>
      <p>キーボードによる移動とアニメーションを組み合わせてプログラムを完成させましょう。
      新しいpythonファイル<code>move.py</code>を作成してください。<a
      href="https://github.com/k-768/PythonGameProgramming/blob/main/programs/move.py">ここから</a>プログラムをコピー＆ペーストして実行してみてください。WASDでキャラクターが<strong>歩いて移動します</strong>。このプログラムの要点について解説します。</p>
      <p><br></p>
      <hr />
      <div class="sourceCode" id="cb21" data-startFrom="138"
      data-caption="move.py（抜粋）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 137;"><span id="cb21-138"><a href="#cb21-138"></a><span class="co">#マップ座標からキャラをどこに配置するか決める関数</span></span>
<span id="cb21-139"><a href="#cb21-139"></a><span class="co">#dx,dy:移動中の微小変化 0,1,2,3,4の4段階</span></span>
<span id="cb21-140"><a href="#cb21-140"></a><span class="kw">def</span> getCharaCoord(x,y,dx<span class="op">=</span><span class="dv">0</span>,dy<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb21-141"><a href="#cb21-141"></a>    <span class="cf">return</span>((x<span class="op">+</span>dx<span class="op">/</span><span class="dv">4</span>)<span class="op">*</span>CHIP_SIZE, (y<span class="op">+</span>dy<span class="op">/</span><span class="dv">4</span><span class="op">-</span><span class="fl">0.5</span>)<span class="op">*</span>CHIP_SIZE)</span></code></pre></div>
      <p><code>138行目</code>からは、キャラクタの座標を計算しています。キャラクターが1マス移動する間に表示する<code>frame</code>は4コマなので、<strong>1コマにつき1/4マスずつ移動する</strong>ことで滑らかな移動ができます。</p>
      <p><br></p>
      <div class="sourceCode" id="cb22" data-startFrom="209"
      data-caption="move.py（抜粋）"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python" style="counter-reset: source-line 208;"><span id="cb22-209"><a href="#cb22-209"></a>    <span class="cf">if</span> flag <span class="op">==</span> <span class="st">&quot;move&quot;</span>:<span class="co">#移動中のとき</span></span>
<span id="cb22-210"><a href="#cb22-210"></a>        <span class="co">#キャラクター再描写</span></span>
<span id="cb22-211"><a href="#cb22-211"></a>        setChara(charaX,charaY,charaD,moveCount)</span>
<span id="cb22-212"><a href="#cb22-212"></a>        </span>
<span id="cb22-213"><a href="#cb22-213"></a>        <span class="cf">if</span> moveCount<span class="op">==</span><span class="dv">3</span>:<span class="co">#アニメーションが最終コマならば</span></span>
<span id="cb22-214"><a href="#cb22-214"></a>            flag <span class="op">=</span> <span class="st">&quot;default&quot;</span><span class="co">#待機中に状態を戻す</span></span>
<span id="cb22-215"><a href="#cb22-215"></a>            moveCount <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-216"><a href="#cb22-216"></a>            charaX <span class="op">+=</span> moveX</span>
<span id="cb22-217"><a href="#cb22-217"></a>            charaY <span class="op">+=</span> moveY</span>
<span id="cb22-218"><a href="#cb22-218"></a>        <span class="cf">else</span>:</span>
<span id="cb22-219"><a href="#cb22-219"></a>            moveCount <span class="op">+=</span> <span class="dv">1</span></span></code></pre></div>
      <p>そして、<strong><code>moveCount</code>が3まで増えたら、一度<code>flag</code>をdefaultに戻します</strong>。これにより、キーボード操作によるキャラクターの移動は完成です。</p>
      <p>次回はいよいよ、釣りと移動と組み合わせて、釣りゲームを完成させましょう。</p>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://k-768.github.io/PythonGameProgramming/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>
